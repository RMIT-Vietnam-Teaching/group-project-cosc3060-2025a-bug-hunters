<!DOCTYPE html>
<html lang="en" data-user-theme="<%= user ? user.theme : 'light' %>">
    <head>
        <meta charset="UTF-8" />
        <title>All Courses</title>

        <!-- Theme Loader - Must be the first script -->
        <script src="/js/themeLoader.js"></script>

        <!-- Bootstrap 5 CSS CDN -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />

        <!-- Bootstrap Icons CDN -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
            rel="stylesheet"
        />

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/navBarStyle.css" />
        <link rel="stylesheet" href="/css/allCourse.css" />
        <link rel="stylesheet" href="/css/courseSection.css" /> <!-- Important: Include your course card CSS -->
        <link rel="stylesheet" href="/css/darkMode.css" />
    </head>
    <body class="<%= user ? user.theme : 'light' %>" <% if (user && user._id) { %>data-user-id="<%= user._id %>"<% } %>>
        <!-- Include Nav Bar -->
        <%- include('partials/navbar') %>

        <div class="container my-4">
            <h2>All Courses</h2>

            <!-- Fixed Category Buttons -->
            <div class="category-buttons d-flex align-items-center mb-4 position-relative">
                <button class="btn btn-sm btn-light rounded-circle position-absolute start-0" style="z-index: 10;" onclick="scrollCategories(-200)">
                    <i class="bi bi-chevron-left"></i>
                </button>
                
                <div class="categories-container mx-4 overflow-auto" style="white-space: nowrap; scrollbar-width: none; -ms-overflow-style: none;" id="categoriesContainer">
                    <a href="/courses" class="btn <%= !selectedCategory ? 'btn-warning' : 'btn-outline-secondary' %> me-2">All</a>
                    <% categories.forEach(category => { %>
                        <a href="/courses?category=<%= category %>" 
                           class="btn <%= selectedCategory === category ? 'btn-warning' : 'btn-outline-secondary' %> me-2">
                            <%= category %>
                        </a>
                    <% }); %>
                </div>
                
                <button class="btn btn-sm btn-light rounded-circle position-absolute end-0" style="z-index: 10;" onclick="scrollCategories(200)">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>

            <!-- Course Cards Grid using EXACT same structure as homepage -->
            <div class="container">
                <div class="row" id="courseList">
                    <% if (courses && courses.length > 0) { %> 
                        <% courses.forEach(course => { %>
                            <!-- Direct copy of your homepage course card structure -->
                            <div class="col-md-4 mb-4">
                                <div class="card h-100 shadow-sm d-flex flex-column">
                                    <!-- Add category badge -->
                                    <div class="course-category"><%= course.category || 'General' %></div>
                                    
                                    <!-- Card image -->
                                    <img
                                        src="<%= course.image || 'images/course-placeholder.jpg' %>"
                                        class="card-img-top"
                                        alt="<%= course.name %>"
                                    />
                                    
                                    <!-- Card body with flex-grow to push metadata to bottom -->
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title fw-bold text-center"><%= course.name %></h5>
                                        <p class="text-center text-muted">
                                            <% if (course.author && typeof course.author === 'object') { %>
                                                by <%= course.author.firstName %> <%= course.author.lastName %>
                                            <% } else { %>
                                                by <%= course.author || 'Unknown Instructor' %>
                                            <% } %>
                                        </p>
                                        
                                        <!-- Fixed-height description container with overflow handling -->
                                        <div class="description-container" style="height: 80px; overflow: hidden; margin-bottom: 10px;">
                                            <p class="card-text">
                                                <% if (course.description) { %> 
                                                    <%= course.description.substring(0, 100) %>
                                                    <%= course.description.length > 100 ? '...' : '' %> 
                                                <% } else { %>
                                                    No description available. 
                                                <% } %>
                                            </p>
                                        </div>
                                        
                                        <!-- Course metadata - will always be at the bottom thanks to mt-auto -->
                                        <div class="course-meta-container mt-auto">
                                            <div>
                                                <i class="bi bi-clock me-2"></i> 
                                                <%= course.duration || 'Duration not specified' %>
                                            </div>
                                            <div>
                                                <i class="bi bi-star-fill me-2"></i> 
                                                <%= typeof course.rating === 'number' ? course.rating.toFixed(1) : '0.0' %> 
                                                (<%= course.reviews?.length || Math.floor(Math.random() * 1000) %>)
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Make entire card clickable -->
                                    <a href="/courses/<%= course._id %>" class="card-link-wrapper" aria-label="View <%= course.name %>"></a>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="col-12 text-center py-5">
                            <p>No courses available yet.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>

        <!-- Category scroll script -->
        <script>
            function scrollCategories(amount) {
                const container = document.getElementById('categoriesContainer');
                container.scrollBy({ left: amount, behavior: 'smooth' });
            }
            
            // Debug log for dark mode
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Theme loaded:', document.body.classList.contains('dark') ? 'dark' : 'light');
            });
        </script>
    </body>
</html>